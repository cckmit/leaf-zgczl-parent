<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.leaf-framework.org/application" xmlns:s="aurora.plugin.script" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
    <a:init-procedure>
        <s:server-script import="contract_print_path.js"><![CDATA[
            $ctx.parameter.file_path = con_print_path['con_print_path'];
            $ctx.parameter.tomcat_source = con_print_path['tomcat_source'];
        ]]></s:server-script>
        <a:model-query defaultWhereClause="t1.parent_table is null and t1.tab_type!=&apos;TAB&apos; and t1.enabled_flag=&apos;Y&apos; and rownum=1" fetchAll="true" model="cont.CON500.con_hls_doc_layout_tab_query" rootPath="base_table_path"/>
    </a:init-procedure>
    <a:view>
	<a:link id="con731_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.screen"/>
        <a:link id="${/parameter/@layout_code}_hls_fin_doc_quotation_link_id" url="${/request/@context_path}/modules/hls/HLS500/hls_fin_doc_quotation.svc"/>
        <a:link id="${/parameter/@layout_code}_hls_fin_calculator_update_link_id" url="${/request/@context_path}/modules/hls/HLS500N/hls_fin_calculator_update_n.screen"/>
        <a:link id="${/parameter/@layout_code}_hls_fin_calculator_readonly_link_id" url="${/request/@context_path}/modules/hls/HLS500/hls_fin_calculator_readonly.screen"/>
        <a:link id="${/parameter/@layout_code}_special_fields_link_id" model="cont.CON500.con_contract_get_special_fields" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}_con110_submit_link" model="cont.CON110.submit_change_req" modelaction="execute"/>
        <a:link id="${/parameter/@tab_code}_con_contract_balance_link_id" url="${/request/@context_path}/modules/cont/CON305/con_contract_balance.screen"/>
        <a:link id="${/parameter/@layout_code}_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.screen"/>
        <a:link id="${/parameter/@layout_code}_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.screen"/>
        <a:link id="${/parameter/@layout_code}_hls530_get_journal_period" model="hls.HLS301.get_journal_period" modelaction="execute"/>
        <a:link id="${/parameter/@layout_code}_hls530_get_journal_number" model="hls.HLS301.get_journal_number" modelaction="execute"/>
        <a:link id="${/parameter/@layout_code}_prj401_insert_prj_chance_statements" model="db.prj_chance_pkg.insert_prj_chance_statements" modelaction="execute"/>
        <a:link id="${/parameter/@layout_code}_hls_business_management" model="hls.HLS405.hls_business_management_submit" modelaction="update"/>
        <a:link id="${/parameter/@layout_code}${/parameter/@tab_code}_view_pdf_id" url="${/request/@context_path}/modules/view_pdf.screen"/>
        <a:link id="${/parameter/@layout_code}_prj_emplyee_assign_id" url="${/request/@context_path}/modules/prj/PRJ401N/prj_chance_assign_wfl.screen"/>
        <a:link id="print_doc_link_id_d" url="${/request/@context_path}/modules/rsc/RSC401/rsc_risk_review_print_word.screen"/>
        <a:link id="contract_text_repeal_link" model="db.zgc_individual_pkg.contract_text_repeal" modelaction="execute"/>
        <a:link id="con543_prj_secify_approver_link_1" url="${/request/@context_path}/modules/cont/CON731/con_specify_approver.screen"/>
        <a:link id="risk_info_link" url="${/request/@context_path}/modules/rsc/RSC510/rsc_risk_monitor.screen"/>
        <a:link id="${/parameter/@layout_code}_prj_chance_modify_id" url="${/request/@context_path}/modules/prj/PRJ401/prj_chance_update_entrance.screen"/>
        <a:link id="prj_chance_dowload_uploadfile" url="${/request/@context_path}/modules/prj/PRJ400/lease_atm_batch_dl.svc"/>
        <link href="${/request/@context_path}/css/lightbox.css" rel="stylesheet" type="text/css"/>
        <script src="${/request/@context_path}/javascripts/lightbox.js"/>
        <!--2018-04-18 by 9796-->
        <a:link id="con731f_approver_info_win_link" url="${/request/@context_path}/modules/cont/CON543/prj_project_approver_query.screen"/>
        <script><![CDATA[
            Ext.ux.Lightbox.register('a[ref=img]', true);
            
            /*add by wcs
             //desc:该页面为南山项目所有非树类的动态页面
             */
            
            //忽略保存校验方法
            //window['${/parameter/@layout_code}_ignore_required_before_save'] = function() {
            //商机提交
            //if (check_releated_layout('CHANCE')) {
            //window['${/parameter/@layout_code}_not_ignore_required_flag'] = false;
            //}
            //};     
            //退出
            window['${/parameter/@layout_code}_user_button8_layout_dynamic_click'] = function() {
                window.location.href = '${/request/@context_path}/modules/prj/PRJ401/prj_chance_update_entrance.screen?layout_code=CHANCE_MODIFY&function_code=PRJ401';
            };
            
            var dynamic_document_id = '${/parameter/@document_id}';
            
            //dataset字段更新事件
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
            
                if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var rec = $(ds_id).getAt(0);
                    if (ds.id == ds_id) {
                        if (name == 'tenant_id') {
                            rec.getField('contract_id').setLovPara('tenant_id', rec.get('tenant_id'));
                        }
                    }
            
                    //  var line_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_lns');
                    ///  for (var i = 0;i < $(line_ds).getAll().length;i++) {
                    //      $(line_ds).getAt(i).set('tenant_id', rec.get('tenant_id'));
                    //  }
                }
            
                //凭证新增，维护模块
                if (check_releated_layout('SUBSYSTEM_JE')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_journal_header');
                    var rec = $(ds_id).getAt(0);
                    if (ds.id == ds_id) {
                        if (name == 'journal_date') {
                            Aurora.request({
                                url: $('${/parameter/@layout_code}_hls530_get_journal_period').getUrl(),
                                para: {
                                    journal_date: value
                                },
                                success: function(res) {
                                    $(ds_id).getAt(0).set('period_year', res.result.period_year);
                                    $(ds_id).getAt(0).set('period_name', res.result.period_name);
                                    $(ds_id).getAt(0).set('period_set_code', res.result.period_set_code);
                                    $(ds_id).getAt(0).set('internal_period_num', res.result.internal_period_num);
                                }
                            });
                        }
                    }
                }
            
                //渠道维护 金额，数字验证
                if (check_releated_layout('CHANNEL_MESSAGE_DEATIL')) {
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    var rec = $(ds_id_1).getAt(0);
                    var regx = /^[0-9]*$/g;
                    if (name == 'constacts_phone' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '联系人电话输入类型有误，请重新输入！');
                        }
                    }
                }
            
                //非业务类合同维护 金额，数字验证
                if (check_releated_layout('CON_UNBUSINESS_MANAGE')) {
                    var ds_id_2 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_unbusiness_contract');
                    var rec = $(ds_id_2).getAt(0);
                    var regx = /^[0-9]*$/g;
                    if (name == 'contract_amount' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '合同总额输入类型有误，请重新输入！');
                        }
                    } else if (rec.get('contract_valid_date_from') > rec.get('contract_valid_date_to')) {
                        Aurora.showMessage('${l:PROMPT}', '合同期限从不能大于合同期限到，请重新输入！');
                    }
                }
            
            
                if (check_releated_layout('CHANNEL_MESSAGE_OTHER')) {
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    var rec = $(ds_id_1).getAt(0);
                    var regx = /^[0-9]*$/g;
                    if (name == 'constacts_phone' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '联系人电话输入类型有误，请重新输入！');
                        }
                    }
                }
            
                if (check_releated_layout('CHANNEL_MESSAGE_XH')) {
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    var rec = $(ds_id_1).getAt(0);
                    var regx = /^[0-9]*$/g;
                    var d = new Date();
                    var date = d.getTime();
                    // var str = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
                    // var date = Aurora.formatDate(str);
                    if (name == 'constacts_phone' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '联系人电话输入类型有误，请重新输入！');
                        }
                    } else if (name == 'member_year_amount' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '会费金额输入类型有误，请重新输入！');
                        }
                    } else if (name == 'member_date' && value) {
                        if (value.getTime() > date) {
                            Aurora.showMessage('${l:PROMPT}', '会员加入时间大于当前时间，请重新输入！');
                        }
                    } else if (name == 'member_money_dare' && value) {
                        if (value.getTime() > date) {
                            Aurora.showMessage('${l:PROMPT}', '会费缴纳时间大于当前时间，请重新输入！');
                        }
                    }
                }
            
                if (check_releated_layout('BUSINESS_MANAGEMENT_DETAIL')) {
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_business_opp');
                    var ds_id_2 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_business_opp_linkman');
                    var rec = $(ds_id_1).getAt(0);
                    var regx = /^[0-9]*$/g;
            
                    if (name == 'finance_amount' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '融资金额输入类型有误，请重新输入！');
                        }
                    } else if (name == 'paid_in_capital' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '实收资本输入类型有误，请重新输入！');
                        }
                    } else if (name == 'registered_capital' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '注册资本输入类型有误，请重新输入！');
                        }
                    } else if (name == 'cellphone' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '手机号码输入类型有误，请重新输入！');
                        }
                    } else if (name == 'fax' && value) {
                        if (!regx.test(value)) {
                            Aurora.showMessage('${l:PROMPT}', '传真输入类型有误，请重新输入！');
                        }
                    }
                }
            
            };
            
            //新增时调用(grid,table,gridBox)
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_add'] = function(ds, record, config_records, bp_seq) {
            
                if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var rec = $(ds_id).getAt(0);
                    record.set('tenant_id', rec.get('tenant_id'));
                } else if (check_releated_layout('CHANCE_MODIFY') || check_releated_layout('PROJECT_MODIFY')) {
                    var prj_quotation_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_quotation');
            
                    var records = ds.getAll();
                    var version_num = 0;
                    var sysdate = new Date();
                    if (records.length) {
                        for (var i = 0;i < records.length;i++) {
                            var current_record = records[i],
                                version = current_record.get('version');
                            if (!Ext.isEmpty(version)) {
                                index = version.indexOf('v');
                                if (index == -1) {
                                    version_num = version_num;
                                } else {
                                    var current_version = version.substring(index + 1);
                                    if (isNaN(current_version) || parseFloat(current_version) <= parseFloat(version_num)) {
                                        version_num = version_num;
                                    } else {
                                        version_num = current_version;
                                    }
                                }
                            }
                        }
                    }
                    record.set('version', 'v' + parseInt(plus(version_num, 1)).toFixed(1));
                    record.set('contract_seq', parseInt(plus(version_num, 1)));
                    record.set('quotation_date', sysdate);
                }
            
                if (ds.id == prj_quotation_ds_id) {
                    var records = ds.getAll();
                    var count = 0;
                    for (var i = 0;i < records.length;i++) {
                        var quotation_type = records[i].get('quotation_type');
                        if (quotation_type == 'MAJOR') {
                            count++;
                        }
                        if (count > 1) {
                            Aurora.showMessage('${l:PROMPT}', '只能保存一个主报价！');
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            return false;
                        }
                    }
                    window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                }
            };
            
            //加载时调用(grid,table,gridBox)
            //add by Harry 9952 2017/12/13
            window['${/parameter/@layout_code}_on_layout_dynamic_form_add_and_load'] = function(ds, record, config_records, bp_seq) {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                if (ds.id == ds_id) {
                    if (check_releated_layout('VISIT_REPORT_MODIFY') && '${/parameter/@period_name}') {
                        var period_end_date = '${/parameter/@period_name}'.substr(0, 4) + '-' + '${/parameter/@period_name}'.substr(4, 2);
            
                        var d = new Date(period_end_date);
                        d.setMonth(d.getMonth() - 1);
                        var period_start_date = (d.getFullYear() + "-" + (d.getMonth()));
            
                        if (period_start_date.length == 6) {
                            period_start_date = period_start_date.substr(0, 5) + '0' + period_start_date.substr(5, 1);
                        }
            
                        record.set('visit_check_start_date', period_start_date);
                        record.set('visit_check_start_date_n', period_start_date);
            
                        record.set('visit_check_end_date', period_end_date);
                        record.set('visit_check_end_date_n', period_end_date);
            
                    }
                } 
            };
            
            //加载时候调用
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record, config_records, bp_seq) {
                if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var rec = $(ds_id).getAt(0);
            
                    var line_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_lns');
                    if (ds.id == line_ds) {
                        for (var i = 0;i < ds.getAll().length;i++) {
                            ds.getAt(i).set('tenant_id', rec.get('tenant_id'));
                        }
                    }
                }
            };
            
            function check_releated_layout(releated_table) {
                var str = '${/parameter/@layout_code}';
                //商机
                if (str.indexOf(releated_table) >= 0) {
                    return true;
                } else {
                    return false;
                }
            }
            
            function quote_link(type, record_id) {
            
            
                window['${/parameter/@layout_code}_lock_layout_dynamic_window'];
                var prj_chance_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                var prj_chance_record = $(prj_chance_ds_id).getAt(0);
                var prj_quotation_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_quotation');
            
                var prj_quotation_record = $(prj_quotation_ds_id).findById(record_id);
            
            
                var calc_recreate_L_formula;
                var saveData = [];
                if (type == 'quote') {
                    url = $('${/parameter/@layout_code}_hls_fin_calculator_update_link_id').getUrl();
                } else {
                    url = $('${/parameter/@layout_code}_hls_fin_calculator_readonly_link_id').getUrl();
                    if (!prj_quotation_record.get('calc_session_id')) {
                        Aurora.showMessage('${l:PROMPT}', '无可用报价！');
                        return;
                    } else {
                        new Aurora.Window({
                            id: '${/parameter/@layout_code}_hls_fin_calc_readonly_link_winid',
                            params: {
                                document_id: '${/parameter/@document_id}',
                                document_category: '${/parameter/@document_category}',
                                maintain_type: 'READONLY',
                                calc_session_id: prj_quotation_record.get('calc_session_id'),
                                winId: '${/parameter/@layout_code}_hls_fin_calc_readonly_link_winid',
                                global_flag: 'Y',
                                calc_type: 'CLASSIC_CALCULATOR'
                            },
                            url: url,
                            fullScreen: true,
                            draggable: true
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window'];
                        return;
                    }
                }
                prj_quotation_record.set('to_doc_table', 'HLS_FIN_CALCULATOR_HD');
                prj_quotation_record.set('function_code', '${/parameter/@function_code}');
                prj_quotation_record.set('function_usage', '${/parameter/@function_usage}');
                prj_quotation_record.set('document_id', prj_quotation_record.get('chance_id'));
            
                if (prj_quotation_record.get('quotation_id') && !prj_quotation_record.get('calc_session_id')) {
                    calc_recreate_L_formula = 'Y';
                    prj_quotation_record.set('_status', 'update');
                } else if (prj_quotation_record.get('quotation_id') && prj_quotation_record.get('calc_session_id')) {
                    calc_recreate_L_formula = 'N';
                    prj_quotation_record.set('_status', 'execute');
                }
                //防止多次点击出现插入多个报价的情况 点击报价前要执行保存
                else if (!prj_quotation_record.get('chance_id') || !prj_quotation_record.get('quotation_id')) {
                    Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                    return;
                } else {
                    calc_recreate_L_formula = 'Y';
                    prj_quotation_record.set('_status', 'insert');
                }
            
                prj_quotation_record.set('from_doc_table', 'PRJ_QUOTATION');
                prj_quotation_record.set('from_doc_pk', prj_quotation_record.get('quotation_id'));
                prj_quotation_record.set('calculate_flag', 'N');
                saveData.push(prj_quotation_record.data);
                Aurora.request({
                    url: $('${/parameter/@layout_code}_hls_fin_doc_quotation_link_id').getUrl(),
                    para: saveData,
                    success: function(res) {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window'];
                        //$(prj_quotation_ds_id).setQueryParameter('chance_id', prj_quotation_record.get('chance_id'));
                        //$(prj_quotation_ds_id).query();
                        var quotation_id = prj_quotation_record.get('quotation_id') || res.result.quotation_id;
                        var win = new Aurora.Window({
                            id: '${/parameter/@layout_code}_hls_fin_calc_quotation_link_winid',
                            params: {
                                document_id: prj_quotation_record.get('chance_id'),
                                document_category: '${/parameter/@document_category}',
                                maintain_type: '${/parameter/@maintain_type}',
                                calc_session_id: res.result.record.calc_session_id,
                                quotation_id: quotation_id,
                                dsId: prj_quotation_ds_id,
                                winId: '${/parameter/@layout_code}_hls_fin_calc_quotation_link_winid',
                                global_flag: 'Y',
                                id_num: 0,
                                calc_type: '${/parameter/@calc_type}',
                                recreate_L_formula: calc_recreate_L_formula
                            },
                            url: url,
                            // title: '${l:HLS.FIN_CALCULATOR}',
                            fullScreen: true,
                            draggable: true
                        });
                        win.on('close', function() {
                            $(prj_quotation_ds_id).setQueryParameter('chance_id', prj_quotation_record.get('chance_id'));
                            //$(hls_fin_calculator_ln_ds_id).setQueryParameter('project_id', project_id);
                            $(prj_quotation_ds_id).query();
                            //$(hls_fin_calculator_ln_ds_id).query();
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window'];
                        });
                    },
                    failure: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window'];
                    },
                    error: function() {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window'];
                    },
                    scope: this
                });
            }
            
            //租赁物明细
            //租赁物详细
            window['${/parameter/@layout_code}_lease_item_list'] = function(ds_id, record_id, name) {
                var lease_type = $(ds_id).findById(record_id).get('lease_type') + '_QUERY';
                //获取对应的产品线
                //var base_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                // var division = $(base_ds_id).getCurrentRecord().get('division');
                if ($(ds_id).findById(record_id).get('contract_lease_item_id')) {
                    new Aurora.Window({
                        id: 'receipt_print_winid',
                        url: '${/request/@context_path}/modules/prj/PRJ501N/prj_lease_item_detail.screen',
                        params: {
                            contract_lease_item_id: $(ds_id).findById(record_id).get('contract_lease_item_id'),
                            lease_type: lease_type
                        },
                        title: '租赁物明细',
                        height: 550,
                        width: 900
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            //按钮渲染
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_dynamic_button_renderer'] = function(value, record, name, config_record, bp_seq) {
                var link_function = '';
                //商机
                if (check_releated_layout('CHANCE')) {
                    if (name.indexOf('quote') >= 0) {
                        link_function = 'quote_link';
                        if (Ext.isIE || Ext.isIE9 || Ext.isIE10) {
                            return '<button style="font-size:11px;height:22px;width:70%;text-align:center;padding:0 4px 4px 0" onclick="window[\'' + link_function + '\'](\'' + name + '\',\'' + record.id + '\');"><div style="height: 18px; line-height: 16px; text-decoration: none;">' + config_record.get('prompt') + '</div></button>';
                        } else {
                            return '<button style="font-size:11px;height:22px;width:70%;text-align:center;" onclick="window[\'' + link_function + '\'](\'' + name + '\',\'' + record.id + '\');">' + config_record.get('prompt') + '</button>';
                        }
                    }
                }
                // if (Ext.isIE || Ext.isIE9 || Ext.isIE10) {
                // return '<button style="font-size:11px;height:22px;width:70%;text-align:center;padding:0 4px 4px 0" onclick="window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');"><div style="height: 18px; line-height: 16px; text-decoration: none;">' + config_record.get('prompt') + '</div></button>';
                // } else {
                // return '<button style="font-size:11px;height:22px;width:70%;text-align:center;" onclick="window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');">' + config_record.get('prompt') + '</button>';
                // }
            };
            
            //超链接
            window['${/parameter/@bp_seq}${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record, bp_seq) {
                //处理附件上传超链接
                var link_function = '';
                //商机
                if (check_releated_layout('CHANCE')) {
                    if (name.indexOf('quote') >= 0) {
                        return '<a style="color:red" href="javascript:quote_link(\'' + name + '\',\'' + record.id + '\')">报价</a>';
            
                    }
                }
            
                //回访报告维护-承租人合同明细
                if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    if (name == 'tenant_contract_detail') {
                        return '<a href="javascript:open_visit_tenant_window(' + record.get('tenant_id') + ')">承租人合同明细</a>';
                    } else if (name == 'financial_template_load') {
                        return '<a href="javascript:open_financial_template_load_window(' + record.get('tenant_id') + ')">财务报表导入</a>';
                    } else if (name == 'financial_template_query') {
                        return '<a href="javascript:open_financial_template_query_window(' + record.get('tenant_id') + ')">财务报表数据查看</a>';
                    }
                }
            
                if (check_releated_layout('VISIT_REPORT_QUERY_ZGC')) {
                    if (name == 'tenant_contract_detail') {
                        return '<a href="javascript:open_visit_tenant_window(' + record.get('tenant_id') + ')">承租人合同明细</a>';
                    } else if (name == 'financial_template_load') {
                        return '<a href="javascript:open_financial_template_load_window(' + record.get('tenant_id') + ')">财务报表导入</a>';
                    } else if (name == 'financial_template_query') {
                        return '<a href="javascript:open_financial_template_query_window(' + record.get('tenant_id') + ')">财务报表数据查看</a>';
                    }
                }
            
                if (check_releated_layout('CONTRACT_MODIFY') || check_releated_layout('CON_CONTEXT_CONFIRM_QUERY') || check_releated_layout('CON_CONTEXT_CONFIRM') || check_releated_layout('CONTRACT_QUERY') || check_releated_layout('BP_BANK_MODIFY') || check_releated_layout('BP_BANK_QUERY')) {
                    if (name == 'li_list') {
                        var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_lease_item');
                        link_function = '${/parameter/@layout_code}_lease_item_list';
                        return '<a href="javascript:window[\'' + link_function + '\'](\'' + ds_id + '\',\'' + record.id + '\',\'' + name + '\');">' + config_record.get('prompt') + '</a>';
                    }
                    if (name == 'attachment') {
                        if (check_releated_layout('CONTRACT_MODIFY')) {
                            var ds_id = record.ds.id;
                            link_function = '${/parameter/@layout_code}_con500_cdd_attachtment_upload';
                            return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + ds_id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                        } else if (check_releated_layout('BP_BANK_MODIFY') || check_releated_layout('BP_BANK_QUERY')) {
                            var ds_id = record.ds.id;
                            link_function = '${/parameter/@layout_code}_csh501_cdd_attachtment_upload';
                            return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + ds_id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                        }
                    } else if (name == 'attach_file_name') {
                        if (value != null) {
                            var link = '${/request/@context_path}/atm_download.svc?attachment_id=';
                            var str = value.split(';;');
                            var url = '';
                            var file_name;
                            for (var i = 0;i < str.length;i++) {
                                var temp = str[i].split('--');
                                if (!Aurora.isEmpty(temp[0])) {
                                    file_name = temp[0].toUpperCase();
                                    if (file_name.indexOf('.PDF') >= 0) {
                                        url = url + '<a href=javascript:view_pdf(\'' + temp[1] + '\')>' + temp[0] + '</a>' + ',';
                                    } else if (file_name.indexOf('.GIF') >= 0 || file_name.indexOf('.JPG') >= 0 | file_name.indexOf('.JPEG') >= 0 || file_name.indexOf('.PNG') >= 0) {
                                        url = url + '<a href=' + link + temp[1] + ' ref="img">' + temp[0] + '</a>' + ',';
                                    } else {
                                        url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                    }
                                }
                            }
                            return url;
                        }
                    }
                }
            
                window['${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
                if (name == 'attachment') {
                    if (check_releated_layout('BP_MASTER_POLICY_SUBSIDY')) {
                        link_function = '${/parameter/@layout_code}_hls320_cdd_attachtment_upload';
                        return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                    } else if (check_releated_layout('CON731E')) {
                        link_function = '${/parameter/@layout_code}_con731e_cdd_attachtment_upload';
                        return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                    } else if (check_releated_layout('CON733D')) {
                        link_function = 'cdd_attachtment_downloadFile';
                        var ds_id = record.ds.id;
                        var render_desc = '下载';
                        return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + ds_id + '\',\'' + name + '\');">' + render_desc + '</a>';
            
                    }else {
                        link_function = '${/parameter/@layout_code}_hls213n_cdd_attachtment_upload';
                        return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                    }
                } else if (name == 'attach_file_name') {
                    if (value != null) {
                        var link = '${/request/@context_path}/atm_download.svc?attachment_id=';
                        var str = value.split(';;');
                        var url = '';
                        var file_name;
                        for (var i = 0;i < str.length;i++) {
                            var temp = str[i].split('--');
                            if (!Aurora.isEmpty(temp[0])) {
                                file_name = temp[0].toUpperCase();
                                if (file_name.indexOf('.PDF') >= 0) {
                                    url = url + '<a href=javascript:view_pdf(\'' + temp[1] + '\')>' + temp[0] + '</a>' + ',';
                                } else if (file_name.indexOf('.GIF') >= 0 || file_name.indexOf('.JPG') >= 0 | file_name.indexOf('.JPEG') >= 0 || file_name.indexOf('.PNG') >= 0) {
                                    url = url + '<a href=' + link + temp[1] + ' ref="img">' + temp[0] + '</a>' + ',';
                                } else {
                                    url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
                                }
                            }
                        }
                        return url;
                    }
                }
            };
		
	    // add by zhangdan 20180517
	    function cdd_attachtment_downloadFile(id, ds_id, name) {
                var record = $(ds_id).findById(id);
                if (record.get('contract_text_changes_l_id')) {
                    
                   var url=$('con731_cdd_downloadFile_id').getUrl() + '?table_name=CON_CONTRACT_TEXT_CHANGES_L&header_id=' + record.get('contract_text_changes_l_id');
            
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: 'con733_cdd_downloadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            }            

            function view_pdf(attachment_id) {
                Aurora.request({
                    url: '${/request/@context_path}/autocrud/fnd.fnd_atm_attachment/query',
                    para: {
                        attachment_id: attachment_id
                    },
                    success: function(res) {
                        var path = res.result.record.file_path;
                        path = path.substr(path.indexOf('hls_attachment'));
                        var tomcat_source = '${/parameter/@tomcat_source}';
                        var source_path = 'http://' + window.location.host + '/' + tomcat_source + '/' + path;
                        var oWin = window.open(source_path);
            
                    },
                    scope: this
                });
            }
            
            window['${/parameter/@layout_code}_hls213n_cdd_attachtment_upload'] = function(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('check_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    } else {
                        url = $('${/parameter/@layout_code}_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_hls213n_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            window['${/parameter/@layout_code}_hls320_cdd_attachtment_upload'] = function(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('subsidy_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}_cdd_downloadFile_id').getUrl() + '?table_name=HLS_BP_MASTER_SUBSIDY&header_id=' + record.get('subsidy_id');
                    } else {
                        url = $('${/parameter/@layout_code}_cdd_uploadFile_id').getUrl() + '?table_name=HLS_BP_MASTER_SUBSIDY&header_id=' + record.get('subsidy_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_hls320_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            window['${/parameter/@layout_code}_con731e_cdd_attachtment_upload'] = function(id, name, query_only) {
                var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('contract_text_changes_l_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}_cdd_downloadFile_id').getUrl() + '?table_name=CON_CONTRACT_TEXT_CHANGES_L&header_id=' + record.get('contract_text_changes_l_id');
                    } else {
                        url = $('${/parameter/@layout_code}_cdd_uploadFile_id').getUrl() + '?table_name=CON_CONTRACT_TEXT_CHANGES_L&header_id=' + record.get('contract_text_changes_l_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_con731e_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    /*  win.on('close', function() {
                     record.ds.query();
                     }); */
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            
            //承租人合同明细子窗口
            
            function open_visit_tenant_window(tenant_id) {
            
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                var rec = $(ds_id).getAt(0);
                url = $('${/parameter/@tab_code}_con_contract_balance_link_id').getUrl();
                if (!rec.get('tenant_id')) {
                    Aurora.showMessage('${l:PROMPT}', '${l:CON801.MAINTAIN_TENANT_INFO_FIRST}');
                    return;
                }
                new Aurora.Window({
                    id: '${/parameter/@tab_code}_con_contract_balance_link_winid',
                    params: {
                        bp_id: rec.get('tenant_id'),
                        winid: '${/parameter/@tab_code}_con_contract_balance_link_winid'
                    },
                    url: url,
                    fullScreen: true,
                    draggable: true
                });
            }
            
            //财务报表模板导入
            
            function open_financial_template_load_window(tenant_id) {
                new Aurora.Window({
                    id: 'rsc_fin_statement_prj_import_handle_winid',
                    url: '${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_import_handle.screen',
                    params: {
                        bp_id: tenant_id,
                        function_code: '${/parameter/@function_code}',
                        winid: 'rsc_fin_statement_prj_import_handle_winid'
                    },
                    title: '${l:STATEMENTS_BUSINESS_DATA_IMPORT}',
                    width: 950,
                    height: 200
                });
            }
            
            //财务报表模板查看
            
            function open_financial_template_query_window(tenant_id) {
                new Aurora.Window({
                    id: 'rsc_fin_statement_prj_all_query_winid',
                    url: '${/request/@context_path}/modules/rsc/RSC303/rsc_fin_statement_prj_all_query.screen',
                    params: {
                        bp_id: tenant_id,
                        function_code: '${/parameter/@function_code}',
                        winid: 'rsc_fin_statement_prj_all_query_winid'
                    },
                    title: '${l:STATEMENTS_BUSINESS_DATA_IMPORT}',
                    fullScreen: true,
                    draggable: true
                });
            }
            
            
            //提交标志(全局)
            var submit_wfl_flag = 'N';
            
            function confirm_submit() {
                if (check_releated_layout('CHANCE')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                    if (ds_id == 'CHANCE_MODIFY_BASIC_prj_chance_ds') {
                        $('CHANCE_MODIFY_submit_approval').disable();
                    }
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var prj_chance_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交立项审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: prj_chance_record.get('chance_id'),
                                    document_category: '${/parameter/@document_category}',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    if (ds_id == 'CHANCE_MODIFY_BASIC_prj_chance_ds') {
                                        $('CHANCE_MODIFY_submit_approval').enable();
                                    }
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    // $('${/parameter/@winid}').close();
                                    Aurora.go($('${/parameter/@layout_code}_prj_chance_modify_id').getUrl());
            
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //渠道信息提交审批
                else if (check_releated_layout('CHANNEL_MESSAGE_DEATIL')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var channle_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交立项审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: channle_record.get('channel_id'),
                                    document_category: 'CHANNEL',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //渠道信息协会提交审批
                else if (check_releated_layout('CHANNEL_MESSAGE_XH')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var channle_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交立项审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: channle_record.get('channel_id'),
                                    document_category: 'CHANNEL',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //渠道信息其他提交审批
                else if (check_releated_layout('CHANNEL_MESSAGE_OTHER')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var channle_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交立项审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: channle_record.get('channel_id'),
                                    document_category: 'CHANNEL',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //商机管理提交审批
                else if (check_releated_layout('BUSINESS_MANAGEMENT_DETAIL')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_business_opp');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var business_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交审批流
                            Aurora.request({
                                url: $('${/parameter/@layout_code}_hls_business_management').getUrl(),
                                para: {
                                    document_id: business_record.get('business_opp_id'),
                                    document_category: 'BUSINESS',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //租后报告维护提交审批
                else if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var business_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交审批流
                            Aurora.request({
                                //url: $('${/parameter/@layout_code}_hls_business_management').getUrl(),
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: business_record.get('visit_report_id'),
                                    document_category: 'VISIT_REPORT',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //非业务类合同提交审批
                else if (check_releated_layout('CON_UNBUSINESS_MANAGE')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_unbusiness_contract');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var business_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: business_record.get('unbusiness_contract_id'),
                                    document_category: 'OTHERS',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //合同文本变更工作流提交审批
                else if (check_releated_layout('CON731E')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_text_changes_hd');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var business_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: business_record.get('contract_text_changes_id'),
                                    document_category: 'CHANGE_REQUEST',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //租赁资产分级提交审批
                else if (check_releated_layout('ASSETS_REPORT_ENTRY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'asset_hierarchic_enter');
                    if (ds_id) {
                        if (submit_wfl_flag == 'Y') {
                            var asset_hierarchic_record = $(ds_id).getAt(0);
                            submit_wfl_flag = 'N';
            
                            //提交审批流
                            Aurora.request({
                                url: '${/request/@context_path}/autocrud/cont.CON500.con_contract_submit/update',
                                para: {
                                    document_id: asset_hierarchic_record.get('asset_hierarchic_id'),
                                    document_category: 'OTHERS',
                                    function_code: '${/parameter/@function_code}',
                                    function_usage: '${/parameter/@function_usage}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                                    Aurora.SideBar.enable = true;
                                    Aurora.SideBar.show({
                                        msg: '${l:HLS.SUBMIT_SUCCESS}',
                                        duration: 2000
                                    });
                                    $('${/parameter/@winid}').close();
                                },
                                failure: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    submit_wfl_flag = 'N';
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        }
                    }
                }
                //浮动利率提交
                else if (check_releated_layout('CONTRACT_INTEREST_FLOAT')) {
                    var root_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                    var req_record = root_ds.getAt(0);
                    if (root_ds.validate()) {
                        if (req_record.dirty) {
                            Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                            return;
                        }
                        var winid = '${/parameter/@winid}';
                        Aurora.showConfirm('${l:HLS.PROMPT}', '${l:HLS.ARE_YOU_SURE_TO_SUBMIT}', function() {
                            Aurora.request({
                                url: $('${/parameter/@layout_code}_con110_submit_link').getUrl(),
                                para: {
                                    change_req_id: '${/parameter/@change_req_id}'
                                },
                                success: function(res) {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                    $('${/parameter/@winid}').close();
            
                                },
                                failure: function() {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                error: function() {
                                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                },
                                scope: this
                            });
                        });
                    }
                }
            }
            
            //保存前调用，生成单据编号
            window['${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function(ds, record) {
                //$('VISIT_REPORT_MODIFY_save').disable();
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                //商机提交
                if (check_releated_layout('CHANCE')) {
            
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_quotation');
                    var rec = $(ds_id_1).getAll();
                    var record;
                    var quotation_type;
                    var count = 0;
                    //if (quotation_type == 'MAJOR') {
                    for (var i = 0;i < rec.length;i++) {
                        if (rec.length > 1) {
            
                            record = $(ds_id_1).getAt(i);
                            quotation_type = record.get('quotation_type');
                            if (quotation_type == 'MAJOR') {
                                count++;
            
                            }
                            if (count > 1) {
                                Aurora.showMessage('${l:PROMPT}', '只能保存一个主报价！');
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                                return false;
                            }
                        }
                    }
                    //}
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                    var prj_chance_record = $(ds_id).getAt(0);
                    if (prj_chance_record.get('document_category') == 'CHANCE' && !prj_chance_record.get('chance_number')) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_special_fields_link_id').getUrl(),
                            para: {
                                document_category: '${/parameter/@document_category}',
                                document_type: '${/parameter/@document_type}',
                                function_code: '${/parameter/@function_code}',
                                function_usage: '${/parameter/@function_usage}'
                            },
                            success: function(res) {
                                var document_number = res.result.document_number;
                                if (prj_chance_record.get('document_category') == 'CHANCE') {
                                    prj_chance_record.set('chance_number', document_number);
                                }
                            },
                            error: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            failure: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            sync: true,
                            scope: this
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    }
                }
                //渠道信息保存,渠道编码
                else if (check_releated_layout('CHANNEL_MESSAGE_OTHER') || check_releated_layout('CHANNEL_MESSAGE_XH') || check_releated_layout('CHANNEL_MESSAGE_DEATIL')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_business_channel');
                    var business_channel_record = $(ds_id).getAt(0);
                    if (!business_channel_record.get('channel_coding')) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_special_fields_link_id').getUrl(),
                            para: {
                                document_category: 'CHANNEL',
                                document_type: 'CHANNEL_REQ',
                                function_code: '${/parameter/@function_code}',
                                function_usage: '${/parameter/@function_usage}'
                            },
                            success: function(res) {
                                var document_number = res.result.document_number;
                                business_channel_record.set('channel_coding', document_number);
                            },
                            error: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            failure: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            sync: true,
                            scope: this
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    }
                }
                //商机编码
                else if (check_releated_layout('BUSINESS_MANAGEMENT_DETAIL')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_business_opp');
                    var business_management_record = $(ds_id).getAt(0);
                    if (!business_management_record.get('business_opp_code')) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_special_fields_link_id').getUrl(),
                            para: {
                                document_category: 'BUSINESS',
                                document_type: 'BUSINESS_REQ',
                                function_code: '${/parameter/@function_code}',
                                function_usage: '${/parameter/@function_usage}'
                            },
                            success: function(res) {
                                var document_number = res.result.document_number;
                                business_management_record.set('business_opp_code', document_number);
                            },
                            error: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            failure: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            sync: true,
                            scope: this
                        });
                        //window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    }
                }
                //租后管理维护编码
                else if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var business_management_record = $(ds_id).getAt(0);
                    if (!business_management_record.get('visit_report_code')) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_special_fields_link_id').getUrl(),
                            para: {
                                document_category: 'VISIT_REPORT',
                                document_type: 'VISIT_REPORT_REQ',
                                function_code: '${/parameter/@function_code}',
                                function_usage: '${/parameter/@function_usage}'
                            },
                            success: function(res) {
                                var document_number = res.result.document_number;
                                business_management_record.set('visit_report_code', document_number);
                            },
                            error: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            failure: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            sync: true,
                            scope: this
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    }
                }
                //非业务类合同编号
                else if (check_releated_layout('CON_UNBUSINESS_MANAGE')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_unbusiness_contract');
                    var con_unbusiness_management_record = $(ds_id).getAt(0);
                    if (!con_unbusiness_management_record.get('unbusiness_contract_number')) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_special_fields_link_id').getUrl(),
                            para: {
                                document_category: 'OTHERS',
                                document_type: 'UNBUSINESS_REQ',
                                function_code: '${/parameter/@function_code}',
                                function_usage: '${/parameter/@function_usage}'
                            },
                            success: function(res) {
                                var document_number = res.result.document_number;
                                con_unbusiness_management_record.set('unbusiness_contract_number', document_number);
                            },
                            error: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            failure: function() {
                                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                            },
                            sync: true,
                            scope: this
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    }
                }
                //凭证新增，获取凭证编号
                else if (check_releated_layout('SUBSYSTEM_JE_ADD')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_journal_header');
                    var rec = $(ds_id).getAt(0);
                    Aurora.request({
                        url: $('${/parameter/@layout_code}_hls530_get_journal_number').getUrl(),
                        para: {
                            je_company_id: rec.get('je_company_id'),
                            document_type: '${/parameter/@document_type}',
                            journal_date: rec.get('journal_date')
                        },
                        success: function(res) {
                            $(ds_id).getAt(0).set('journal_num', res.result.journal_num);
                        }
                    });
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    return true;
                } else if (check_releated_layout('CON731E')) {
                    // 2018-04-18 by 9796
                    /* var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_text_changes_hd');
                    var record = $(ds_id).getAt(0);
                    record.set('content_change_desc', '${/parameter/@description}'); */
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    return true;
                } else {
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    return true;
                }
            };
            
            //保存submitfailed调用
            window['${/parameter/@layout_code}_on_layout_dynamic_submitfailed'] = function(ds, record, res) {
                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                submit_wfl_flag = 'N';
            
            };
            
            //保存submitsuccess调用
            window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'] = function(ds, record, res) {
                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                if (submit_wfl_flag == 'Y') {
                    window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                    Aurora.showConfirm('${HLS.PROMPT}', '${l:HLS.ARE_YOU_SURE_TO_SUBMIT}', confirm_submit, function() {
                        submit_wfl_flag = 'N';
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                    })
                } else if (check_releated_layout('CHANCE')) {
                    window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                    record = $(ds_id).getAt(0);
                    $('${/parameter/@layout_code}_ACY_prj_cdd_item_doc_ref_ds').setQueryParameter('cdd_list_id', record.get('cdd_list_id'));
                    $('${/parameter/@layout_code}_ACY_prj_cdd_item_doc_ref_ds').query();
                    var cdd_item_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
                    var prj_cdd_item_doc_ref_ds = $(cdd_item_ds_id);
            
                    function prj_cdd_item_doc_ref_load() {
                        //取消重复监听
                        prj_cdd_item_doc_ref_ds.un('load', prj_cdd_item_doc_ref_load);
                        $(cdd_item_ds_id).submit();
                    }
                    prj_cdd_item_doc_ref_ds.on('load', prj_cdd_item_doc_ref_load);
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                } else if (check_releated_layout('VISIT_REPORT_MODIFY')) {
            
                    var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    record = $(ds_id_1).getAt(0);
                    $(ds_id_1).setQueryParameter('visit_report_id', record.get('visit_report_id'));
                    $(ds_id_1).query();
                    //$('VISIT_REPORT_MODIFY_save').enable();
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                } else {
                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                }
                //立项创建，维护直接带出财务指标
                if ('${/parameter/@layout_code}' == 'CHANCE_MODIFY') {
                    debugger;
                    window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                    var statements_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance_statements');
                    var chance_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                    var chance_id = $(chance_ds_id).getAt(0).get('chance_id');
                    if (chance_ds_id == 'CHANCE_MODIFY_BASIC_prj_chance_ds') {
                        $('CHANCE_MODIFY_save').disable();
                        $('CHANCE_MODIFY_submit_approval').disable();
                    }
                    if (chance_id) {
                        window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_prj401_insert_prj_chance_statements').getUrl(),
                            para: {
                                chance_id: chance_id
                            },
                            success: function(res) {
                                $(statements_ds_id).setQueryParameter('chance_id', chance_id);
                                $(statements_ds_id).query();
                                if (chance_ds_id == 'CHANCE_MODIFY_BASIC_prj_chance_ds') {
                                    $('CHANCE_MODIFY_save').enable();
                                    $('CHANCE_MODIFY_submit_approval').enable();
                                }
                            }
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
            
                    }
                }
            };
            
            //立项 财务信息指标加载
            window['${/parameter/@layout_code}_FIN_STATEMENTS_USER_BUTTON1_layout_dynamic_tab_click'] = function() {
                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance_statements');
                var ds_id_1 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                var prj_chance_record = $(ds_id_1).getAt(0);
                var chance_id = prj_chance_record.get('chance_id');
                if (check_releated_layout('CHANCE')) {
                    if (chance_id) {
                        Aurora.request({
                            url: $('${/parameter/@layout_code}_prj401_insert_prj_chance_statements').getUrl(),
                            para: {
                                chance_id: chance_id
                            },
                            success: function(res) {
                                $(ds_id).setQueryParameter('chance_id', res.result.chance_id);
                                $(ds_id).query();
                            }
                        });
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        return true;
                    } else {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        Aurora.showMessage('提示', '请先保存！');
                        return true;
                    }
                }
            };
            
            //立项指派
            window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                if (check_releated_layout('CHANCE')) {
                    var chance_id = '${/parameter/@chance_id}';
                    new Aurora.Window({
                        url: $('${/parameter/@layout_code}_prj_emplyee_assign_id').getUrl(),
                        params: {
                            chance_id: chance_id,
                            instance_id: '${/parameter/@instance_id}'
            
                        },
                        title: '工作流指派',
                        id: 'prj_emplyee_assign_id_wcs',
                        width: 300,
                        height: 150
                    });
                }
            };
            
            //项目审批单  （合同文本变更工作流中） 2018-04-18 by 9796
            window['${/parameter/@layout_code}_user_button4_layout_dynamic_click'] = function() {
                if (check_releated_layout('CON731F')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_text_changes_hd');
                    var record = $(ds_id).getAt(0);
                    var win = new Aurora.Window({
                        id: 'con731f_approver_info_win_id',
                        url: $('con731f_approver_info_win_link').getUrl(),
                        params: {
                            project_id: record.get('project_id'),
                            winid: 'con731f_approver_info_win_id'
                        },
                        title: '上会信息',
                        fullScreen: true
                    });
                }
            };
            //租后报告 风险预警
            /* window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
             if (check_releated_layout('VISIT_REPORT_MODIFY')) {
             location.href = $('risk_info_link').getUrl();
             parent.shMenu('show');
             } else if (check_releated_layout('VISIT_REPORT_QUERY_ZGC')) {
             location.href = $('risk_info_link').getUrl();
             parent.shMenu('show');
             }
             }; */
            
            //审批页面中打包下载
            window['${/parameter/@layout_code}_user_button5_layout_dynamic_click'] = function() {
                var prj_chance_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_chance');
                var prj_chance_record = $(prj_chance_ds_id).getAt(0);
                // var tenant_info_record = $('${/parameter/@layout_code}_BP_INFO_MANAGER_prj_project_bp_ds').getAt(0);
                var chance_id = prj_chance_record.get('chance_id');
                var chance_number = prj_chance_record.get('chance_number');
                var bp_name = prj_chance_record.get('bp_id_n');
                var doc_code = chance_number + '_' + bp_name;
                var url_l = $('prj_chance_dowload_uploadfile').getUrl() + '?document_id=' + chance_id + '&document_table=PRJ_CHANCE' + '&doc_code=' + encodeURI(doc_code) + '&all_flag=Y';
                window.open(href = url_l, target = "_self");
            };
            
            window['${/parameter/@layout_code}_submit_approval_layout_dynamic_click'] = function() {
                //商机
                if (check_releated_layout('CHANCE')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
                    }
                }
                //渠道信息
                else if (check_releated_layout('CHANNEL_MESSAGE_DEATIL')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
                    }
                } else if (check_releated_layout('CHANNEL_MESSAGE_OTHER')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
                    }
                } else if (check_releated_layout('CHANNEL_MESSAGE_XH')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
                    }
                }
                //商机管理
                else if (check_releated_layout('BUSINESS_MANAGEMENT_DETAIL')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
            
                    }
                }
                //非业务类合同维护
                else if (check_releated_layout('CON_UNBUSINESS_MANAGE')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
            
                    }
                }
                //合同文本变更
                else if (check_releated_layout('CON731E')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_text_changes_hd');
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (typeof($(ds_id).getAt(0)) == 'undefined') {
                        Aurora.showMessage('提示', '文本变更提交审批前，请先进行保存！');
                        return;
                    } else {
                        if (root_ds.validate()) {
                            submit_wfl_flag = 'Y';
                            confirm_submit();
            
                            //  2018-04-09 by 9796
                            /*    var record = $(ds_id).getAt(0);
                             var contract_text_changes_id = record.get('contract_text_changes_id');
                             var document_table = 'CON_CONTRACT';
                             var title = '合同变更指定信审员';
                             var win = new Aurora.Window({
                             id: 'lsh_prj_secify_approver_screen_1',
                             url: $('con543_prj_secify_approver_link_1').getUrl(),
                             params: {
                             document_id: contract_text_changes_id,
                             specify_code: 'PROJECT_CREDIT_APPROVER'
                             },
                             title: title,
                             width: 550,
                             heigh: 650
                             });
                             win.on('close', function() {
                             submit_wfl_flag = 'Y';
                             confirm_submit();
                             }); */
            
                        }
                    }
                    // if (root_ds.validate()) {
                    // //提交先保存
                    // window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                    // submit_wfl_flag = 'Y';
            
                    // }
            
                }
                //租后管理维护
                else if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
            
                    }
                }
                //租赁资产分级
                else if (check_releated_layout('ASSETS_REPORT_ENTRY')) {
                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
                    if (root_ds.validate()) {
                        //提交先保存
                        window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();
                        submit_wfl_flag = 'Y';
            
                    }
                }
            };
            
            //租赁资产分级导出
            // window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
            // Aurora.showConfirm('提示', '确定打印选中项？', function() {
            // Aurora.Masker.mask(Ext.getBody(), '正在提交');
            // var templt_name = 'rsc_asset_hierarchic_report.xml';
            // var url = $('print_doc_link_id_d').getUrl() + '?templt_name=' + templt_name + '&asset_hierarchic_id=${/parameter/@asset_hierarchic_id}';
            // var form = document.createElement("form");
            // form.target = "word_export_window";
            // form.method = "post";
            // form.action = url;
            // var iframe = Ext.get('word_export_window') || new Ext.Template('<iframe id ="word_export_window" name="word_export_window" style="position:absolute;left:-10000px;top:-10000px;width:1px;height:1px;display:none"></iframe>').insertFirst(document.body, {}, true);
            // document.body.appendChild(form);
            // form.submit();
            // Ext.fly(form).remove();
            // Aurora.Masker.unmask(Ext.getBody());
            // });
            // };
            //合同文本变更---撤销按钮
            window['${/parameter/@layout_code}_user_button3_layout_dynamic_click'] = function() {
                Aurora.showConfirm('提示', '确定撤销变更？', function() {
                    var contract_text_changes_id= '${/parameter/@contract_text_changes_id}';
                    Aurora.request({
                        url: $('contract_text_repeal_link').getUrl(),
                        para: {
                            contract_text_changes_id: contract_text_changes_id
                        },
                        success: function(res) {
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
			    $('con733_manage_result_ds').query();
                            $('${/parameter/@winid}').close();
            
                        },
                        failure: function() {
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        error: function() {
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        },
                        scope: this
                    });
                });
            };
            
            //报价按钮
            window['${/parameter/@layout_code}_quote_layout_dynamic_click'] = function() {
                if (check_releated_layout('CONTRACT_MODIFY')) {
                    var con_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                    var base_ds = $(con_ds_id);
                    var head_record = base_ds.getAt(0);
                    var parent_base_table_pk = 'project_id';
                    var url = $('${/parameter/@layout_code}_hls_fin_calculator_update_link_id').getUrl();
            
                    // if ('${/parameter/@calc_type}' == 'LITE_CALCULATOR') {
                    // url = $('${/parameter/@layout_code}_hls_fin_calculator_readonly_link_id').getUrl();
                    // } else if ('${/parameter/@calc_type}' == 'CLASSIC_CALCULATOR') {
                    // url = $('${/parameter/@layout_code}_hls_fin_calculator_update_link_id').getUrl();
                    // } else {
                    // Aurora.showMessage('${l:PROMPT}', '${l:HLS.CALC_TYPE_IS_NULL}');
                    // return;
                    // }
                    if (head_record.dirty == true) {
                        Aurora.showMessage('${l:PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    }
                    if (1) {
                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        var win = new Aurora.Window({
                            id: 'hls_fin_calc_quotation_link_winid',
                            params: {
                                document_id: head_record.get('contract_id'),
                                document_category: '${/parameter/@document_category}',
                                maintain_type: '${/parameter/@maintain_type}',
                                calc_session_id: head_record.get('calc_session_id'),
                                //quotation_id: var quotation_id = record.get('quotation_id');,
                                dsId: con_ds_id,
                                winId: 'hls_fin_calc_quotation_link_winid',
                                global_flag: 'Y',
                                id_num: 0,
                                calc_type: '${/parameter/@calc_type}',
                                recreate_L_formula: 'Y',
                                calc_recreate_H_formula: 'Y'
                            },
                            url: url,
                            fullScreen: true,
                            draggable: true
                        });
                        win.on('close', function() {
                            $(con_ds_id).setQueryParameter('con_contract', head_record.get('contract_id'));
                            $(con_ds_id).query();
                            window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                        });
                    }
            
                }
            };
            
            //上传附件按钮
            window['${/parameter/@layout_code}_upload_layout_dynamic_click'] = function() {
            
                if (check_releated_layout('VISIT_REPORT_MODIFY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var rec = $(ds_id).getAt(0);
                    //alert(rec.get('visit_report_id'));
                    if (!rec.get('visit_report_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/uploadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('visit_report_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('VISIT_REPORT_QUERY_ZGC')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_visit_report_hds');
                    var rec = $(ds_id).getAt(0);
                    //alert(rec.get('visit_report_id'));
                    if (!rec.get('visit_report_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/downloadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('visit_report_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('CON_UNBUSINESS_MANAGE')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_unbusiness_contract');
                    var rec = $(ds_id).getAt(0);
                    if (!rec.get('unbusiness_contract_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/uploadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('unbusiness_contract_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('CON_UNBUSINESS_RESULT')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'zgc_unbusiness_contract');
                    var rec = $(ds_id).getAt(0);
                    if (!rec.get('unbusiness_contract_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/downloadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('unbusiness_contract_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('ASSETS_REPORT_ENTRY_QUERY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'asset_hierarchic_enter');
                    var rec = $(ds_id).getAt(0);
                    if (!rec.get('asset_hierarchic_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/downloadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('asset_hierarchic_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('ASSETS_REPORT_ENTRY')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'asset_hierarchic_enter');
                    var rec = $(ds_id).getAt(0);
                    if (!rec.get('asset_hierarchic_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var url = '${/request/@context_path}/uploadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('asset_hierarchic_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                } else if (check_releated_layout('CON731E')) {
                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract');
                    var rec = $(ds_id).getAt(0);
                    if (!rec.get('contract_id')) {
                        Aurora.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
                        return;
                    } else {
                        // var dynamic_base_table = '${/model/base_table_path/record/@base_table}'.toUpperCase();
                        var dynamic_base_table = 'CONTRACT_CHANGE_REQ';
                        var url = '${/request/@context_path}/uploadFile.screen?table_name=' + dynamic_base_table + '&header_id=' + rec.get('contract_id');
                        new Aurora.Window({
                            url: url,
                            title: '${l:HLS.SUPPORTING_DOCUMENT}',
                            id: '${/parameter/@attach_tab_code}_con500_cdd_uploadFile_screen_id',
                            width: 850,
                            height: 400
                        });
                    }
                }
            };
            
            window['${/parameter/@layout_code}_con500_cdd_attachtment_upload'] = function(id, ds_id, name, query_only) {
                var record = $(ds_id).findById(id);
                //var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('check_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_DOC_REF&header_id=' + record.get('check_id');
                    } else {
                        url = $('${/parameter/@layout_code}_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_DOC_REF&header_id=' + record.get('check_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_hls320_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
            
            window['${/parameter/@layout_code}_csh501_cdd_attachtment_upload'] = function(id, ds_id, name, query_only) {
                var record = $(ds_id).findById(id);
                //var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
                if (record.get('bank_account_id')) {
                    var url;
                    if (query_only == 'Y') {
                        url = $('${/parameter/@layout_code}_cdd_downloadFile_id').getUrl() + '?table_name=BP_BANK_ATT&header_id=' + record.get('bank_account_id');
                    } else {
                        url = $('${/parameter/@layout_code}_cdd_uploadFile_id').getUrl() + '?table_name=BP_BANK_ATT&header_id=' + record.get('bank_account_id');
                    }
                    var win = new Aurora.Window({
                        url: url,
                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
                        id: '${/parameter/@layout_code}${/parameter/@tree_code}_hls320_cdd_uploadFile_screen_id',
                        width: 850,
                        height: 400
                    });
                    win.on('close', function() {
                        record.ds.query();
                    });
                } else {
                    Aurora.showMessage('${l:HLS.PROMPT}', '请先保存!');
                }
            };
        ]]></script>
        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.screen"/>
    </a:view>
</a:screen>
